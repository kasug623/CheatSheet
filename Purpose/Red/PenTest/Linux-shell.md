#team/red #os/linux

# TOC <!-- omit in toc -->
- [Crack Hash](#crack-hash)
  - [Hashcat](#hashcat)
  - [John](#john)
- [Network](#network)
  - [RDP](#rdp)
    - [xfreerdp](#xfreerdp)
    - [Remmina](#remmina)
- [Enumeration](#enumeration)
  - [tcpdump](#tcpdump)
  - [Responder](#responder)
  - [fping](#fping)
  - [nmap](#nmap)
  - [kerbrute](#kerbrute)
  - [ldapsearch](#ldapsearch)
- [windapsearch](#windapsearch)
- [Utility](#utility)
  - [CrackMapExec](#crackmapexec)
  - [Samba](#samba)
    - [nmblookup](#nmblookup)
    - [nbtstat](#nbtstat)
    - [net](#net)
    - [rpcclient](#rpcclient)
    - [smbclient](#smbclient)
    - [enum4linux](#enum4linux)
    - [enum4linux-ng](#enum4linux-ng)


# Crack Hash
## Hashcat
Misc
[example_hashes](https://hashcat.net/wiki/doku.php?id=example_hashes)
```zsh
$ hashcat -m 13100 TestUser_tgs /usr/share/wordlists/rockyou.txt
$ hashcat -m 5600 TestUser_ntlmv2 /usr/share/wordlists/rockyou.txt
$ echo "testuser::HOGEDOMAIN:9693dc33a27d0fad:65ED2DB3C8CABC535766CEEA790F5B90:0101000000000000005B16A7A85DDA0101783E12CBC277F00000000002000800560035003700380001001E00570049004E002D0041004D004C0035005400580048005A0031004D00340004003400570049004E002D0041004D004C0035005400580048005A0031004D0034002E0056003500370038002E004C004F00430041004C000300140056003500370038002E004C004F00430041004C000500140056003500370038002E004C004F00430041004C0007000800005B16A7A85DDA010600040002000000080030003000000000000000000000000030000046842C6450A0BA4C94522DF804CFB768388069149C8B2EE410B9FF7D91E1AF420A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000" > backupagent_hash
$ hashcat -m 5600 ./testuser_hash /usr/share/wordlists/rockyou.txt
$ hashcat -m 13100 ./SAPService_tgs /usr/share/wordlists/rockyou.txt
$ hashcat -m 13100 -a 0 ./GetUserSPNs-py_hashcat.txt ./TestPasswordList.txt
# AS-REP roast
$ hashcat -m 18200 output_GetNPUsers.txt /usr/share/wordlists/rockyou.txt
# DCSync
$ hashcat -m 1000 outout_mimikatz_dcsync_hashes.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
## John
Misc

# Network
## RDP
### xfreerdp
```zsh
$ xfreerdp /v:XXX.XXX.XXX.XXX /u:TestUser /p:TestPassword /dynamic-resolution +clipboard
$ xfreerdp /v:XXX.XXX.XXX.XXX /d:hoge.com /u:TestUser /p:TestPassword /dynamic-resolution
$ xfreerdp /v:XXX.XXX.XXX.XXX /d:hoge.com /u:TestUser /p:'P@$$W0rd' /dynamic-resolution
# bad
## $ has a special meaning
## $ xfreerdp /v:XXX.XXX.XXX.XXX /d:hoge.com /u:TestUser /p:P@$$W0rd /dynamic-resolution
```
`/dynamic-resolution` option may not work well.

### Remmina
```zsh
$ remmina -c rdp://TestUser@XXX.XXX.XXX.XXX
```

# Enumeration
## tcpdump  
Initial Enumeration  
```zsh
$ sudo tcpdump -i ens224
```

## Responder  
Initial Enumeration  
Protocol: LLMNR, NBT-NS, and MDNS  
```zsh
$ sudo responder -I ens224 -A
$ sudo responder -I ens224
```
/usr/share/responder/logs
/usr/share/responder/Responder.conf 

## fping  
Protocol: ICMP  
```zsh
$ fping -asgq 172.16.5.0/23
```

## nmap
```zsh
$ sudo nmap XXX.XXX.XXX.XXX -p49555 -sV
$ sudo nmap XXX.XXX.XXX.XXX -A -sV -sC -p-
$ sudo nmap XXX.XXX.XXX.XXX -A -sV -sC -p8080
$ sudo nmap -sV -sC -p139,445 172.16.5.5
$ sudo nmap -sV -sC -p 0-10000 172.16.5.5
$ sudo nmap -A -p- 172.16.5.5
$ sudo nmap -sV -p- 172.16.5.130
$ sudo nmap -sV -p- 172.16.5.225
$ sudo nmap -v -A -iL hosts.txt -oN /home/htb-student/Documents/host-enum
```
-A: Aggressive scan. ref.https://nmap.org/book/man-misc-options.html

## kerbrute
Enumerating Users
Protocol: Kerberos
```zsh
$ kerbrute userenum -d HOGE.local --dc 172.16.0.10 mylist.txt -o valid_ad_users
# Password Spraying - Making a Target User List - Without a valid domain account - Kerberos Pre-Authentication 
## Pre-setup
## $ sudo echo 1721.16.0.10 HOGE.com >> /etc/hosts
$ kerbrute userenum --dc HOGE.com -d HOGE.com ./userlist.txt
$ kerbrute userenum -d hogehoge.local --dc XXX.XXX.XXX.XXX /opt/jsmith.txt
$ kerbrute userenum -d hogehoge.local --dc XXX.XXX.XXX.XXX /opt/jsmith.txt > result.txt
$ cat result.txt | awk -F " " '{printf("%s\n", $7)}' | grep @ | sed 's/@inlanefreight\.local//' > valid_users.txt
# Password Spraying - Authentication Attempt - With a valid username - SMB
$ kerbrute passwordspray -d hoge.local --dc 172.17.0.1 valid_users.txt TestPassword
```

## ldapsearch
Protocol: LDAP
Enumerating the Password Policy, LDAP Anonymous Bind
```zsh
$ ldapsearch -h 172.16.0.2 -x -b "DC=HOGE,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength
# Password Spraying - Making a Target User List - Without a valid domain account - LDAP anonymous bind
$ ldapsearch -h 172.16.0.2 -x -b "DC=HOGE,DC=COM" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
```

# windapsearch
Protocol: LDAP
https://github.com/ropnop/windapsearch
```zsh
$ ./windapsearch.py -h
# Password Spraying - Making a Target User List - Without a valid domain account - LDAP anonymous bind
$ ./windapsearch.py --dc-ip XXX.XXX.XXX.XXX -u "" -U
$ python3 windapsearch.py --dc-ip XXX.XXX.XXX.XXX -u TestSpnAccountUser -p TestSpnAccountPassword -PU
$ python3 windapsearch.py --dc-ip XXX.XXX.XXX.XXX -u TestUser@hoge.local -p TestPassword --da
```
# Utility
## CrackMapExec
Enumeration, Lateral Movement
Protocol: SMB, LDAP, WinRM, RDP, Kerberos, MSSQL, FTP, SSH, HTTP(S)
```zsh
$ crackmapexec smb -h
$ crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword --pass-pol
# Password Spraying - Making a Target User List - Without a valid domain account - SMB NULL Session to Pull User List
$ crackmapexec smb XXX.XXX.XXX.XXX --users
# Generic - Authentication Attempt - With a valid username - SMB
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword
# Password Spraying - Making a Target User List - With a valid domain account - SMB
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword --users
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword --loggedon-users
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword --shares
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword  -M spider_plus --share 'Test Shares'
# Password Spraying - Making a Target User List - With NT hash for a local administrator account password - SMB
$ sudo crackmapexec smb --local-auth 172.17.0.1/23 -u administrator -H TestNtHash | grep +
$ head -n 10 /tmp/cme_spider_plus/XXX.XXX.XXX.XXX.json
$ set +H
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u TestUser -p TestPassword --groups
# Password Spraying - Authentication Attempt - With a valid username - SMB
$ sudo crackmapexec smb 172.17.0.2 -u valid_users.txt -p TestPasseord | grep +

$ sudo crackmapexec smb --local-auth XXX.XXX.XXX.XXX/23 -u administrator -H TestNTLMhash | grep +
$ sudo crackmapexec smb XXX.XXX.XXX.XXX -u administrator -H TestNTLMhash
```

## Samba
### nmblookup
Protocol: 137/UDP

### nbtstat
Protocol: 137/UDP

### net
Protocol: 139/TCP, 135/TCP, TCP and UDP 135 and 49152-65535

### rpcclient
https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb/rpcclient-enumeration  
https://cheatsheet.haax.fr/network/services-enumeration/135_rpc/  
Protocol: DCE/RPC on SMB ... 135/TCP
```zsh
$ rpcclient -U "" -N XXX.XXX.XXX.XXX
rpcclient $> querydominfo
rpcclient $> getdompwinfo
# Password Spraying - Making a Target User List - Without a valid domain account - SMB NULL Session to Pull User List
rpcclient $> enumdomusers
rpcclient $> queryuser 0x457
rpcclient $> queryuser (RID(hex))
$ rpcclient -U "" -N 172.16.5.5 -c "queryuser 1170"
$ rpcclient -U "" -N 172.16.5.5 -c "enumdomgroups" > a.txt
$ grep Intern a.txt
group:[Interns] rid:[0xff0]
$
$ echo $((16#ff0))
4080
# Password Spraying - Authentication Attempt - With a valid username - SMB
$ for u in $(cat valid_users.txt);do rpcclient -U "$u%TestPassword" -c "getusername;quit" 172.17.0.1 | grep Authority; done
```

### smbclient
Protocol: SMB - 445/TCP
```zsh
$ smbclient -U TestUser -N XXX.XXX.XXX.xXX
```

### enum4linux
`enum4linux` is a tool that combines `smbclient`, `rpcclient`, and `nmblookup` to perform SMB enumeration against Windows and Samba systems.
Protocol: SMB(CIFS) - 445/TCP & 139/TCP（NetBIOS over TCP）, NetBIOS- 137/UDP & 138/UDP
```zsh
# sudo echo 172.16.0.10 hoge.com >> /etc/hosts
$ enum4linux -a hoge.com | tee output_enum4linux_a_hoge-com.ans
$ enum4linux -a XXX.XXX.XXX.XXX | tee output_enum4linux_a_ip.ans
$ enum4linux -P XXX.XXX.XXX.XXX
# Password Spraying - Making a Target User List - Without a valid domain account - SMB NULL Session to Pull User List
$ enum4linux -U XXX.XXX.XXX.XXX | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
```

### enum4linux-ng
```zsh
$ enum4linux-ng -P 172.16.0.10 -oA my_output
$ cat my_output.json
```